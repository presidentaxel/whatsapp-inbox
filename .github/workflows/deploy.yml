name: Deploy to OVH Server

on:
  workflow_run:
    workflows: ["Tests and Validation"]
    types:
      - completed
  # Permet aussi de dÃ©ployer manuellement
  workflow_dispatch:

jobs:
  # VÃ©rifier que les tests sont passÃ©s
  check-tests:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Check test status
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "âœ… DÃ©ploiement manuel autorisÃ©"
          elif [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "âœ… Tests validÃ©s, dÃ©ploiement autorisÃ©"
          else
            echo "âŒ Les tests doivent passer avant le dÃ©ploiement"
            exit 1
          fi

  deploy:
    needs: check-tests
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to OVH Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: ${{ secrets.OVH_SSH_PORT || 22 }}
          script: |
            set -e
            
            echo "ğŸš€ DÃ©ploiement en cours..."
            
            # Trouver le projet
            PROJECT_DIR=$(find ~ /opt /home /var/www -type d -name "whatsapp-inbox" 2>/dev/null | head -1)
            if [ -z "$PROJECT_DIR" ]; then
              COMPOSE_FILE=$(find / -name "docker-compose.prod.yml" 2>/dev/null | head -1)
              if [ -n "$COMPOSE_FILE" ]; then
                PROJECT_DIR=$(dirname "$COMPOSE_FILE")
              else
                echo "âŒ Projet non trouvÃ©"
                exit 1
              fi
            fi
            
            cd "$PROJECT_DIR"
            echo "ğŸ“ RÃ©pertoire: $(pwd)"
            
            # Pull les derniÃ¨res modifications
            echo "ğŸ“¥ Pull depuis GitHub..."
            git fetch origin
            CURRENT_BRANCH=$(git branch --show-current || echo "main")
            git reset --hard "origin/$CURRENT_BRANCH" || git reset --hard origin/main || git reset --hard origin/master
            
            # Aller dans deploy
            cd deploy 2>/dev/null || cd .
            
            # S'assurer que BACKEND_URL est dÃ©fini (CRITIQUE pour Ã©viter les 503)
            if [ -f .env ]; then
              if ! grep -q "^BACKEND_URL=" .env; then
                echo "BACKEND_URL=backend:8000" >> .env
                echo "âœ… BACKEND_URL ajoutÃ© au .env"
              else
                # S'assurer que la valeur est correcte
                sed -i 's|^BACKEND_URL=.*|BACKEND_URL=backend:8000|' .env
                echo "âœ… BACKEND_URL mis Ã  jour dans .env"
              fi
            else
              echo "BACKEND_URL=backend:8000" > .env
              echo "âœ… .env crÃ©Ã© avec BACKEND_URL"
            fi
            
            # VÃ©rifier aussi dans docker-compose.prod.yml
            if [ -f docker-compose.prod.yml ]; then
              if ! grep -q "BACKEND_URL" docker-compose.prod.yml; then
                echo "âš ï¸  BACKEND_URL manquant dans docker-compose.prod.yml"
              fi
            fi
            
            # Rebuild et redÃ©marrer les services
            echo "ğŸ”¨ Rebuild des images..."
            docker compose -f docker-compose.prod.yml build --no-cache backend frontend || true
            
            echo "ğŸ”„ RedÃ©marrage des services..."
            docker compose -f docker-compose.prod.yml up -d --force-recreate
            
            # Attendre que les services soient prÃªts
            echo "â³ Attente du dÃ©marrage..."
            sleep 10
            
            # VÃ©rifier la santÃ©
            echo "ğŸ¥ VÃ©rification de la santÃ©..."
            for i in {1..30}; do
              if docker compose -f docker-compose.prod.yml exec -T backend curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Backend est prÃªt"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âš ï¸  Backend n'est pas prÃªt aprÃ¨s 30 tentatives"
              fi
              sleep 2
            done
            
            # Afficher les logs rÃ©cents
            echo "ğŸ“‹ Logs rÃ©cents:"
            docker compose -f docker-compose.prod.yml logs --tail=20 backend | tail -10 || true
            
            echo "âœ… DÃ©ploiement terminÃ©!"
