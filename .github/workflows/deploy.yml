name: Deploy to OVH Server

on:
  workflow_run:
    workflows: ["Tests and Validation"]
    types:
      - completed
  # Permet aussi de d√©ployer manuellement
  workflow_dispatch:

jobs:
  # V√©rifier que les tests sont pass√©s
  check-tests:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Check test status
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "‚úÖ D√©ploiement manuel autoris√©"
          elif [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "‚úÖ Tests valid√©s, d√©ploiement autoris√©"
          else
            echo "‚ùå Les tests doivent passer avant le d√©ploiement"
            exit 1
          fi

  deploy:
    needs: check-tests
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check SSH secrets
        run: |
          if [ -z "${{ secrets.OVH_HOST }}" ]; then
            echo "‚ùå OVH_HOST secret manquant"
            exit 1
          fi
          # Support √† la fois OVH_USER (ancien) et OVH_USERNAME (nouveau)
          if [ -z "${{ secrets.OVH_USER }}" ] && [ -z "${{ secrets.OVH_USERNAME }}" ]; then
            echo "‚ùå OVH_USER ou OVH_USERNAME secret manquant"
            exit 1
          fi
          if [ -z "${{ secrets.OVH_SSH_KEY }}" ]; then
            echo "‚ùå OVH_SSH_KEY secret manquant"
            exit 1
          fi
          echo "‚úÖ Tous les secrets SSH sont pr√©sents"

      - name: Deploy to OVH Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER || secrets.OVH_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: ${{ secrets.OVH_SSH_PORT || 22 }}
          script: |
            set -e
            
            echo "üöÄ D√©ploiement en cours..."
            
            # Trouver le projet
            PROJECT_DIR=$(find ~ /opt /home /var/www -type d -name "whatsapp-inbox" 2>/dev/null | head -1)
            if [ -z "$PROJECT_DIR" ]; then
              COMPOSE_FILE=$(find / -name "docker-compose.prod.yml" 2>/dev/null | head -1)
              if [ -n "$COMPOSE_FILE" ]; then
                PROJECT_DIR=$(dirname "$COMPOSE_FILE")
              else
                echo "‚ùå Projet non trouv√©"
                exit 1
              fi
            fi
            
            cd "$PROJECT_DIR"
            echo "üìÅ R√©pertoire: $(pwd)"
            
            # Pull les derni√®res modifications
            echo "üì• Pull depuis GitHub..."
            git fetch origin
            CURRENT_BRANCH=$(git branch --show-current || echo "main")
            git reset --hard "origin/$CURRENT_BRANCH" || git reset --hard origin/main || git reset --hard origin/master
            
            # Aller dans deploy
            cd deploy 2>/dev/null || cd .
            
            # S'assurer que BACKEND_URL est d√©fini (CRITIQUE pour √©viter les 503)
            if [ -f .env ]; then
              if ! grep -q "^BACKEND_URL=" .env; then
                echo "BACKEND_URL=backend:8000" >> .env
                echo "‚úÖ BACKEND_URL ajout√© au .env"
              else
                # S'assurer que la valeur est correcte
                sed -i 's|^BACKEND_URL=.*|BACKEND_URL=backend:8000|' .env
                echo "‚úÖ BACKEND_URL mis √† jour dans .env"
              fi
            else
              echo "BACKEND_URL=backend:8000" > .env
              echo "‚úÖ .env cr√©√© avec BACKEND_URL"
            fi
            
            # V√©rifier aussi dans docker-compose.prod.yml
            if [ -f docker-compose.prod.yml ]; then
              if ! grep -q "BACKEND_URL" docker-compose.prod.yml; then
                echo "‚ö†Ô∏è  BACKEND_URL manquant dans docker-compose.prod.yml"
              fi
            fi
            
            # Configurer les variables Google Drive depuis les secrets GitHub
            BACKEND_ENV="../backend/.env"
            if [ ! -f "$BACKEND_ENV" ]; then
              echo "‚ö†Ô∏è  Fichier backend/.env non trouv√©, cr√©ation..."
              mkdir -p ../backend
              touch "$BACKEND_ENV"
            fi
            # Utilisation d'une fonction pour g√©rer l'ajout/mise √† jour de mani√®re s√ªre
            update_env_var() {
              local var_name=$1
              local var_value=$2
              local env_file=$3
              
              if [ -z "$var_value" ]; then
                echo "‚ö†Ô∏è  $var_name non d√©fini dans les secrets GitHub (optionnel)"
                return
              fi
              
              # Supprimer la ligne existante si elle existe, puis ajouter la nouvelle
              grep -v "^${var_name}=" "$env_file" > "${env_file}.tmp" || true
              mv "${env_file}.tmp" "$env_file"
              echo "${var_name}=${var_value}" >> "$env_file"
              echo "‚úÖ $var_name configur√© dans backend/.env"
            }
            
            # Configurer GOOGLE_DRIVE_CLIENT_ID
            update_env_var "GOOGLE_DRIVE_CLIENT_ID" "${{ secrets.GOOGLE_DRIVE_CLIENT_ID }}" "$BACKEND_ENV"
            
            # Configurer GOOGLE_DRIVE_CLIENT_SECRET
            update_env_var "GOOGLE_DRIVE_CLIENT_SECRET" "${{ secrets.GOOGLE_DRIVE_CLIENT_SECRET }}" "$BACKEND_ENV"
            
            # Configurer GOOGLE_DRIVE_REDIRECT_URI
            update_env_var "GOOGLE_DRIVE_REDIRECT_URI" "${{ secrets.GOOGLE_DRIVE_REDIRECT_URI }}" "$BACKEND_ENV"
            
            # Rebuild et red√©marrer les services
            echo "üî® Rebuild des images..."
            docker compose -f docker-compose.prod.yml build --no-cache backend frontend || true
            
            echo "üîÑ Red√©marrage des services..."
            docker compose -f docker-compose.prod.yml up -d --force-recreate
            
            # Attendre que les services soient pr√™ts
            echo "‚è≥ Attente du d√©marrage..."
            sleep 10
            
            # V√©rifier la sant√©
            echo "üè• V√©rification de la sant√©..."
            for i in {1..30}; do
              if docker compose -f docker-compose.prod.yml exec -T backend curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "‚úÖ Backend est pr√™t"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "‚ö†Ô∏è  Backend n'est pas pr√™t apr√®s 30 tentatives"
              fi
              sleep 2
            done
            
            # V√©rifier que les variables Google Drive sont bien configur√©es
            echo "üîç V√©rification des variables Google Drive dans backend/.env:"
            if [ -f "../backend/.env" ]; then
              if grep -q "^GOOGLE_DRIVE_CLIENT_ID=" "../backend/.env"; then
                echo "‚úÖ GOOGLE_DRIVE_CLIENT_ID est configur√©"
              else
                echo "‚ö†Ô∏è  GOOGLE_DRIVE_CLIENT_ID manquant dans backend/.env"
              fi
              if grep -q "^GOOGLE_DRIVE_CLIENT_SECRET=" "../backend/.env"; then
                echo "‚úÖ GOOGLE_DRIVE_CLIENT_SECRET est configur√©"
              else
                echo "‚ö†Ô∏è  GOOGLE_DRIVE_CLIENT_SECRET manquant dans backend/.env"
              fi
              if grep -q "^GOOGLE_DRIVE_REDIRECT_URI=" "../backend/.env"; then
                echo "‚úÖ GOOGLE_DRIVE_REDIRECT_URI est configur√©"
              else
                echo "‚ö†Ô∏è  GOOGLE_DRIVE_REDIRECT_URI manquant dans backend/.env"
              fi
            else
              echo "‚ö†Ô∏è  Fichier backend/.env non trouv√©"
            fi
            
            # Afficher les logs r√©cents
            echo "üìã Logs r√©cents:"
            docker compose -f docker-compose.prod.yml logs --tail=20 backend | tail -10 || true
            
            echo "‚úÖ D√©ploiement termin√©!"
