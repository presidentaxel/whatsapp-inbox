server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # Configuration des types MIME
    # Important: définir les types MIME avant les locations
    types {
        application/javascript js mjs;
        text/css css;
        text/html html;
        image/png png;
        image/jpeg jpg jpeg;
        image/gif gif;
        image/svg+xml svg;
        image/x-icon ico;
        font/woff woff;
        font/woff2 woff2;
        font/ttf ttf;
        font/eot eot;
        application/json json;
        application/pdf pdf;
        application/octet-stream bin;
    }

    # Proxy /_diagnostics vers le backend
    # Cette route doit être proxy vers le backend Render
    # Le backend URL est dans VITE_BACKEND_URL (variable d'environnement)
    # Mais nginx ne peut pas lire les variables d'environnement directement
    # Solution: utiliser un sous-domaine ou une URL fixe
    
    # Pour Render, le backend a sa propre URL (ex: whatsapp-inbox-backend-xxxx.onrender.com)
    # On ne peut pas proxy depuis nginx statique vers un autre service Render
    # Il faut accéder directement à l'URL du backend
    
    # Proxy /api vers le backend (pour les appels API du frontend)
    location /api {
        # En production, le frontend utilise VITE_BACKEND_URL via axios
        # Nginx ne peut pas proxy ici car c'est un service statique
        try_files $uri /index.html;
    }

    # Proxy /_diagnostics vers le backend (même problème)
    location /_diagnostics {
        # Nginx statique ne peut pas proxy vers un autre service
        # Il faut accéder directement à l'URL du backend
        try_files $uri /index.html;
    }

    # Servir les fichiers .mjs avec le bon MIME type
    # Critical: .mjs files must be served as application/javascript for ES modules
    # Utiliser add_header avec always pour forcer le Content-Type même si le fichier existe
    location ~* \.mjs$ {
        add_header Content-Type "application/javascript; charset=utf-8" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        try_files $uri =404;
    }

    # Servir les fichiers .js avec le bon MIME type
    location ~* \.js$ {
        add_header Content-Type "application/javascript; charset=utf-8" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        try_files $uri =404;
    }

    # Servir les autres fichiers statiques avec les bons headers
    location ~* \.(css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|json|pdf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        try_files $uri =404;
    }

    location / {
        try_files $uri /index.html;
    }
}