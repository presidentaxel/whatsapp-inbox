server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # MIME type par défaut pour les fichiers .mjs (JavaScript modules)
    # Important pour que le PDF worker soit chargé correctement
    default_type application/javascript;

    # Proxy /_diagnostics vers le backend
    # Cette route doit être proxy vers le backend Render
    # Le backend URL est dans VITE_BACKEND_URL (variable d'environnement)
    # Mais nginx ne peut pas lire les variables d'environnement directement
    # Solution: utiliser un sous-domaine ou une URL fixe
    
    # Pour Render, le backend a sa propre URL (ex: whatsapp-inbox-backend-xxxx.onrender.com)
    # On ne peut pas proxy depuis nginx statique vers un autre service Render
    # Il faut accéder directement à l'URL du backend
    
    # Proxy /api vers le backend (pour les appels API du frontend)
    location /api {
        # En production, le frontend utilise VITE_BACKEND_URL via axios
        # Nginx ne peut pas proxy ici car c'est un service statique
        try_files $uri /index.html;
    }

    # Proxy /_diagnostics vers le backend (même problème)
    location /_diagnostics {
        # Nginx statique ne peut pas proxy vers un autre service
        # Il faut accéder directement à l'URL du backend
        try_files $uri /index.html;
    }

    # Servir les fichiers .mjs avec le bon MIME type
    location ~* \.mjs$ {
        add_header Content-Type application/javascript;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Servir les autres fichiers statiques avec les bons headers
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    location / {
        try_files $uri /index.html;
    }
}